{"ast":null,"code":"\"use strict\";\n/*\n * Copyright 2019 gRPC authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.extractAndSelectServiceConfig = exports.validateServiceConfig = void 0;\n/* This file implements gRFC A2 and the service config spec:\n * https://github.com/grpc/proposal/blob/master/A2-service-configs-in-dns.md\n * https://github.com/grpc/grpc/blob/master/doc/service_config.md. Each\n * function here takes an object with unknown structure and returns its\n * specific object type if the input has the right structure, and throws an\n * error otherwise. */\n\n/* The any type is purposely used here. All functions validate their input at\n * runtime */\n\n/* eslint-disable @typescript-eslint/no-explicit-any */\n\nconst os = require(\"os\");\n\nconst load_balancer_1 = require(\"./load-balancer\");\n/**\n * Recognizes a number with up to 9 digits after the decimal point, followed by\n * an \"s\", representing a number of seconds.\n */\n\n\nconst TIMEOUT_REGEX = /^\\d+(\\.\\d{1,9})?s$/;\n/**\n * Client language name used for determining whether this client matches a\n * `ServiceConfigCanaryConfig`'s `clientLanguage` list.\n */\n\nconst CLIENT_LANGUAGE_STRING = 'node';\n\nfunction validateName(obj) {\n  if (!('service' in obj) || typeof obj.service !== 'string') {\n    throw new Error('Invalid method config name: invalid service');\n  }\n\n  const result = {\n    service: obj.service\n  };\n\n  if ('method' in obj) {\n    if (typeof obj.method === 'string') {\n      result.method = obj.method;\n    } else {\n      throw new Error('Invalid method config name: invalid method');\n    }\n  }\n\n  return result;\n}\n\nfunction validateMethodConfig(obj) {\n  var _a;\n\n  const result = {\n    name: []\n  };\n\n  if (!('name' in obj) || !Array.isArray(obj.name)) {\n    throw new Error('Invalid method config: invalid name array');\n  }\n\n  for (const name of obj.name) {\n    result.name.push(validateName(name));\n  }\n\n  if ('waitForReady' in obj) {\n    if (typeof obj.waitForReady !== 'boolean') {\n      throw new Error('Invalid method config: invalid waitForReady');\n    }\n\n    result.waitForReady = obj.waitForReady;\n  }\n\n  if ('timeout' in obj) {\n    if (typeof obj.timeout === 'object') {\n      if (!('seconds' in obj.timeout) || !(typeof obj.timeout.seconds === 'number')) {\n        throw new Error('Invalid method config: invalid timeout.seconds');\n      }\n\n      if (!('nanos' in obj.timeout) || !(typeof obj.timeout.nanos === 'number')) {\n        throw new Error('Invalid method config: invalid timeout.nanos');\n      }\n\n      result.timeout = obj.timeout;\n    } else if (typeof obj.timeout === 'string' && TIMEOUT_REGEX.test(obj.timeout)) {\n      const timeoutParts = obj.timeout.substring(0, obj.timeout.length - 1).split('.');\n      result.timeout = {\n        seconds: timeoutParts[0] | 0,\n        nanos: ((_a = timeoutParts[1]) !== null && _a !== void 0 ? _a : 0) | 0\n      };\n    } else {\n      throw new Error('Invalid method config: invalid timeout');\n    }\n  }\n\n  if ('maxRequestBytes' in obj) {\n    if (typeof obj.maxRequestBytes !== 'number') {\n      throw new Error('Invalid method config: invalid maxRequestBytes');\n    }\n\n    result.maxRequestBytes = obj.maxRequestBytes;\n  }\n\n  if ('maxResponseBytes' in obj) {\n    if (typeof obj.maxResponseBytes !== 'number') {\n      throw new Error('Invalid method config: invalid maxRequestBytes');\n    }\n\n    result.maxResponseBytes = obj.maxResponseBytes;\n  }\n\n  return result;\n}\n\nfunction validateServiceConfig(obj) {\n  const result = {\n    loadBalancingConfig: [],\n    methodConfig: []\n  };\n\n  if ('loadBalancingPolicy' in obj) {\n    if (typeof obj.loadBalancingPolicy === 'string') {\n      result.loadBalancingPolicy = obj.loadBalancingPolicy;\n    } else {\n      throw new Error('Invalid service config: invalid loadBalancingPolicy');\n    }\n  }\n\n  if ('loadBalancingConfig' in obj) {\n    if (Array.isArray(obj.loadBalancingConfig)) {\n      for (const config of obj.loadBalancingConfig) {\n        result.loadBalancingConfig.push(load_balancer_1.validateLoadBalancingConfig(config));\n      }\n    } else {\n      throw new Error('Invalid service config: invalid loadBalancingConfig');\n    }\n  }\n\n  if ('methodConfig' in obj) {\n    if (Array.isArray(obj.methodConfig)) {\n      for (const methodConfig of obj.methodConfig) {\n        result.methodConfig.push(validateMethodConfig(methodConfig));\n      }\n    }\n  } // Validate method name uniqueness\n\n\n  const seenMethodNames = [];\n\n  for (const methodConfig of result.methodConfig) {\n    for (const name of methodConfig.name) {\n      for (const seenName of seenMethodNames) {\n        if (name.service === seenName.service && name.method === seenName.method) {\n          throw new Error(`Invalid service config: duplicate name ${name.service}/${name.method}`);\n        }\n      }\n\n      seenMethodNames.push(name);\n    }\n  }\n\n  return result;\n}\n\nexports.validateServiceConfig = validateServiceConfig;\n\nfunction validateCanaryConfig(obj) {\n  if (!('serviceConfig' in obj)) {\n    throw new Error('Invalid service config choice: missing service config');\n  }\n\n  const result = {\n    serviceConfig: validateServiceConfig(obj.serviceConfig)\n  };\n\n  if ('clientLanguage' in obj) {\n    if (Array.isArray(obj.clientLanguage)) {\n      result.clientLanguage = [];\n\n      for (const lang of obj.clientLanguage) {\n        if (typeof lang === 'string') {\n          result.clientLanguage.push(lang);\n        } else {\n          throw new Error('Invalid service config choice: invalid clientLanguage');\n        }\n      }\n    } else {\n      throw new Error('Invalid service config choice: invalid clientLanguage');\n    }\n  }\n\n  if ('clientHostname' in obj) {\n    if (Array.isArray(obj.clientHostname)) {\n      result.clientHostname = [];\n\n      for (const lang of obj.clientHostname) {\n        if (typeof lang === 'string') {\n          result.clientHostname.push(lang);\n        } else {\n          throw new Error('Invalid service config choice: invalid clientHostname');\n        }\n      }\n    } else {\n      throw new Error('Invalid service config choice: invalid clientHostname');\n    }\n  }\n\n  if ('percentage' in obj) {\n    if (typeof obj.percentage === 'number' && 0 <= obj.percentage && obj.percentage <= 100) {\n      result.percentage = obj.percentage;\n    } else {\n      throw new Error('Invalid service config choice: invalid percentage');\n    }\n  } // Validate that no unexpected fields are present\n\n\n  const allowedFields = ['clientLanguage', 'percentage', 'clientHostname', 'serviceConfig'];\n\n  for (const field in obj) {\n    if (!allowedFields.includes(field)) {\n      throw new Error(`Invalid service config choice: unexpected field ${field}`);\n    }\n  }\n\n  return result;\n}\n\nfunction validateAndSelectCanaryConfig(obj, percentage) {\n  if (!Array.isArray(obj)) {\n    throw new Error('Invalid service config list');\n  }\n\n  for (const config of obj) {\n    const validatedConfig = validateCanaryConfig(config);\n    /* For each field, we check if it is present, then only discard the\n     * config if the field value does not match the current client */\n\n    if (typeof validatedConfig.percentage === 'number' && percentage > validatedConfig.percentage) {\n      continue;\n    }\n\n    if (Array.isArray(validatedConfig.clientHostname)) {\n      let hostnameMatched = false;\n\n      for (const hostname of validatedConfig.clientHostname) {\n        if (hostname === os.hostname()) {\n          hostnameMatched = true;\n        }\n      }\n\n      if (!hostnameMatched) {\n        continue;\n      }\n    }\n\n    if (Array.isArray(validatedConfig.clientLanguage)) {\n      let languageMatched = false;\n\n      for (const language of validatedConfig.clientLanguage) {\n        if (language === CLIENT_LANGUAGE_STRING) {\n          languageMatched = true;\n        }\n      }\n\n      if (!languageMatched) {\n        continue;\n      }\n    }\n\n    return validatedConfig.serviceConfig;\n  }\n\n  throw new Error('No matching service config found');\n}\n/**\n * Find the \"grpc_config\" record among the TXT records, parse its value as JSON, validate its contents,\n * and select a service config with selection fields that all match this client. Most of these steps\n * can fail with an error; the caller must handle any errors thrown this way.\n * @param txtRecord The TXT record array that is output from a successful call to dns.resolveTxt\n * @param percentage A number chosen from the range [0, 100) that is used to select which config to use\n * @return The service configuration to use, given the percentage value, or null if the service config\n *     data has a valid format but none of the options match the current client.\n */\n\n\nfunction extractAndSelectServiceConfig(txtRecord, percentage) {\n  for (const record of txtRecord) {\n    if (record.length > 0 && record[0].startsWith('grpc_config=')) {\n      /* Treat the list of strings in this record as a single string and remove\n       * \"grpc_config=\" from the beginning. The rest should be a JSON string */\n      const recordString = record.join('').substring('grpc_config='.length);\n      const recordJson = JSON.parse(recordString);\n      return validateAndSelectCanaryConfig(recordJson, percentage);\n    }\n  }\n\n  return null;\n}\n\nexports.extractAndSelectServiceConfig = extractAndSelectServiceConfig;","map":{"version":3,"mappings":"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","names":["TIMEOUT_REGEX","CLIENT_LANGUAGE_STRING","validateName","obj","service","Error","result","method","validateMethodConfig","name","Array","isArray","push","waitForReady","timeout","seconds","nanos","test","timeoutParts","substring","length","split","_a","maxRequestBytes","maxResponseBytes","validateServiceConfig","loadBalancingConfig","methodConfig","loadBalancingPolicy","config","load_balancer_1","seenMethodNames","seenName","exports","validateCanaryConfig","serviceConfig","clientLanguage","lang","clientHostname","percentage","allowedFields","field","includes","validateAndSelectCanaryConfig","validatedConfig","hostnameMatched","hostname","os","languageMatched","language","extractAndSelectServiceConfig","txtRecord","record","startsWith","recordString","join","recordJson","JSON","parse"],"sources":["C:\\Users\\binel\\OneDrive\\Desktop\\Today\\Udemy\\iProfiler\\iProfiler\\iprofiler\\node_modules\\@grpc\\grpc-js\\src\\service-config.ts"],"sourcesContent":["/*\n * Copyright 2019 gRPC authors.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n *\n */\n\n/* This file implements gRFC A2 and the service config spec:\n * https://github.com/grpc/proposal/blob/master/A2-service-configs-in-dns.md\n * https://github.com/grpc/grpc/blob/master/doc/service_config.md. Each\n * function here takes an object with unknown structure and returns its\n * specific object type if the input has the right structure, and throws an\n * error otherwise. */\n\n/* The any type is purposely used here. All functions validate their input at\n * runtime */\n/* eslint-disable @typescript-eslint/no-explicit-any */\n\nimport * as os from 'os';\nimport { Duration } from './duration';\nimport {\n  LoadBalancingConfig,\n  validateLoadBalancingConfig,\n} from './load-balancer';\n\nexport interface MethodConfigName {\n  service: string;\n  method?: string;\n}\n\nexport interface MethodConfig {\n  name: MethodConfigName[];\n  waitForReady?: boolean;\n  timeout?: Duration;\n  maxRequestBytes?: number;\n  maxResponseBytes?: number;\n}\n\nexport interface ServiceConfig {\n  loadBalancingPolicy?: string;\n  loadBalancingConfig: LoadBalancingConfig[];\n  methodConfig: MethodConfig[];\n}\n\nexport interface ServiceConfigCanaryConfig {\n  clientLanguage?: string[];\n  percentage?: number;\n  clientHostname?: string[];\n  serviceConfig: ServiceConfig;\n}\n\n/**\n * Recognizes a number with up to 9 digits after the decimal point, followed by\n * an \"s\", representing a number of seconds.\n */\nconst TIMEOUT_REGEX = /^\\d+(\\.\\d{1,9})?s$/;\n\n/**\n * Client language name used for determining whether this client matches a\n * `ServiceConfigCanaryConfig`'s `clientLanguage` list.\n */\nconst CLIENT_LANGUAGE_STRING = 'node';\n\nfunction validateName(obj: any): MethodConfigName {\n  if (!('service' in obj) || typeof obj.service !== 'string') {\n    throw new Error('Invalid method config name: invalid service');\n  }\n  const result: MethodConfigName = {\n    service: obj.service,\n  };\n  if ('method' in obj) {\n    if (typeof obj.method === 'string') {\n      result.method = obj.method;\n    } else {\n      throw new Error('Invalid method config name: invalid method');\n    }\n  }\n  return result;\n}\n\nfunction validateMethodConfig(obj: any): MethodConfig {\n  const result: MethodConfig = {\n    name: [],\n  };\n  if (!('name' in obj) || !Array.isArray(obj.name)) {\n    throw new Error('Invalid method config: invalid name array');\n  }\n  for (const name of obj.name) {\n    result.name.push(validateName(name));\n  }\n  if ('waitForReady' in obj) {\n    if (typeof obj.waitForReady !== 'boolean') {\n      throw new Error('Invalid method config: invalid waitForReady');\n    }\n    result.waitForReady = obj.waitForReady;\n  }\n  if ('timeout' in obj) {\n    if (typeof obj.timeout === 'object') {\n      if (\n        !('seconds' in obj.timeout) ||\n        !(typeof obj.timeout.seconds === 'number')\n      ) {\n        throw new Error('Invalid method config: invalid timeout.seconds');\n      }\n      if (\n        !('nanos' in obj.timeout) ||\n        !(typeof obj.timeout.nanos === 'number')\n      ) {\n        throw new Error('Invalid method config: invalid timeout.nanos');\n      }\n      result.timeout = obj.timeout;\n    } else if (\n      typeof obj.timeout === 'string' &&\n      TIMEOUT_REGEX.test(obj.timeout)\n    ) {\n      const timeoutParts = obj.timeout\n        .substring(0, obj.timeout.length - 1)\n        .split('.');\n      result.timeout = {\n        seconds: timeoutParts[0] | 0,\n        nanos: (timeoutParts[1] ?? 0) | 0,\n      };\n    } else {\n      throw new Error('Invalid method config: invalid timeout');\n    }\n  }\n  if ('maxRequestBytes' in obj) {\n    if (typeof obj.maxRequestBytes !== 'number') {\n      throw new Error('Invalid method config: invalid maxRequestBytes');\n    }\n    result.maxRequestBytes = obj.maxRequestBytes;\n  }\n  if ('maxResponseBytes' in obj) {\n    if (typeof obj.maxResponseBytes !== 'number') {\n      throw new Error('Invalid method config: invalid maxRequestBytes');\n    }\n    result.maxResponseBytes = obj.maxResponseBytes;\n  }\n  return result;\n}\n\nexport function validateServiceConfig(obj: any): ServiceConfig {\n  const result: ServiceConfig = {\n    loadBalancingConfig: [],\n    methodConfig: [],\n  };\n  if ('loadBalancingPolicy' in obj) {\n    if (typeof obj.loadBalancingPolicy === 'string') {\n      result.loadBalancingPolicy = obj.loadBalancingPolicy;\n    } else {\n      throw new Error('Invalid service config: invalid loadBalancingPolicy');\n    }\n  }\n  if ('loadBalancingConfig' in obj) {\n    if (Array.isArray(obj.loadBalancingConfig)) {\n      for (const config of obj.loadBalancingConfig) {\n        result.loadBalancingConfig.push(validateLoadBalancingConfig(config));\n      }\n    } else {\n      throw new Error('Invalid service config: invalid loadBalancingConfig');\n    }\n  }\n  if ('methodConfig' in obj) {\n    if (Array.isArray(obj.methodConfig)) {\n      for (const methodConfig of obj.methodConfig) {\n        result.methodConfig.push(validateMethodConfig(methodConfig));\n      }\n    }\n  }\n  // Validate method name uniqueness\n  const seenMethodNames: MethodConfigName[] = [];\n  for (const methodConfig of result.methodConfig) {\n    for (const name of methodConfig.name) {\n      for (const seenName of seenMethodNames) {\n        if (\n          name.service === seenName.service &&\n          name.method === seenName.method\n        ) {\n          throw new Error(\n            `Invalid service config: duplicate name ${name.service}/${name.method}`\n          );\n        }\n      }\n      seenMethodNames.push(name);\n    }\n  }\n  return result;\n}\n\nfunction validateCanaryConfig(obj: any): ServiceConfigCanaryConfig {\n  if (!('serviceConfig' in obj)) {\n    throw new Error('Invalid service config choice: missing service config');\n  }\n  const result: ServiceConfigCanaryConfig = {\n    serviceConfig: validateServiceConfig(obj.serviceConfig),\n  };\n  if ('clientLanguage' in obj) {\n    if (Array.isArray(obj.clientLanguage)) {\n      result.clientLanguage = [];\n      for (const lang of obj.clientLanguage) {\n        if (typeof lang === 'string') {\n          result.clientLanguage.push(lang);\n        } else {\n          throw new Error(\n            'Invalid service config choice: invalid clientLanguage'\n          );\n        }\n      }\n    } else {\n      throw new Error('Invalid service config choice: invalid clientLanguage');\n    }\n  }\n  if ('clientHostname' in obj) {\n    if (Array.isArray(obj.clientHostname)) {\n      result.clientHostname = [];\n      for (const lang of obj.clientHostname) {\n        if (typeof lang === 'string') {\n          result.clientHostname.push(lang);\n        } else {\n          throw new Error(\n            'Invalid service config choice: invalid clientHostname'\n          );\n        }\n      }\n    } else {\n      throw new Error('Invalid service config choice: invalid clientHostname');\n    }\n  }\n  if ('percentage' in obj) {\n    if (\n      typeof obj.percentage === 'number' &&\n      0 <= obj.percentage &&\n      obj.percentage <= 100\n    ) {\n      result.percentage = obj.percentage;\n    } else {\n      throw new Error('Invalid service config choice: invalid percentage');\n    }\n  }\n  // Validate that no unexpected fields are present\n  const allowedFields = [\n    'clientLanguage',\n    'percentage',\n    'clientHostname',\n    'serviceConfig',\n  ];\n  for (const field in obj) {\n    if (!allowedFields.includes(field)) {\n      throw new Error(\n        `Invalid service config choice: unexpected field ${field}`\n      );\n    }\n  }\n  return result;\n}\n\nfunction validateAndSelectCanaryConfig(\n  obj: any,\n  percentage: number\n): ServiceConfig {\n  if (!Array.isArray(obj)) {\n    throw new Error('Invalid service config list');\n  }\n  for (const config of obj) {\n    const validatedConfig = validateCanaryConfig(config);\n    /* For each field, we check if it is present, then only discard the\n     * config if the field value does not match the current client */\n    if (\n      typeof validatedConfig.percentage === 'number' &&\n      percentage > validatedConfig.percentage\n    ) {\n      continue;\n    }\n    if (Array.isArray(validatedConfig.clientHostname)) {\n      let hostnameMatched = false;\n      for (const hostname of validatedConfig.clientHostname) {\n        if (hostname === os.hostname()) {\n          hostnameMatched = true;\n        }\n      }\n      if (!hostnameMatched) {\n        continue;\n      }\n    }\n    if (Array.isArray(validatedConfig.clientLanguage)) {\n      let languageMatched = false;\n      for (const language of validatedConfig.clientLanguage) {\n        if (language === CLIENT_LANGUAGE_STRING) {\n          languageMatched = true;\n        }\n      }\n      if (!languageMatched) {\n        continue;\n      }\n    }\n    return validatedConfig.serviceConfig;\n  }\n  throw new Error('No matching service config found');\n}\n\n/**\n * Find the \"grpc_config\" record among the TXT records, parse its value as JSON, validate its contents,\n * and select a service config with selection fields that all match this client. Most of these steps\n * can fail with an error; the caller must handle any errors thrown this way.\n * @param txtRecord The TXT record array that is output from a successful call to dns.resolveTxt\n * @param percentage A number chosen from the range [0, 100) that is used to select which config to use\n * @return The service configuration to use, given the percentage value, or null if the service config\n *     data has a valid format but none of the options match the current client.\n */\nexport function extractAndSelectServiceConfig(\n  txtRecord: string[][],\n  percentage: number\n): ServiceConfig | null {\n  for (const record of txtRecord) {\n    if (record.length > 0 && record[0].startsWith('grpc_config=')) {\n      /* Treat the list of strings in this record as a single string and remove\n       * \"grpc_config=\" from the beginning. The rest should be a JSON string */\n      const recordString = record.join('').substring('grpc_config='.length);\n      const recordJson: any = JSON.parse(recordString);\n      return validateAndSelectCanaryConfig(recordJson, percentage);\n    }\n  }\n  return null;\n}\n"]},"metadata":{},"sourceType":"script"}